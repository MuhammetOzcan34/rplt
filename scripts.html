<script>
// Sayfa yükleme ve yönlendirme
$(document).ready(function() {
  loadPage('carihesap'); // Varsayılan sayfa

  // Menü tıklama
  $('.nav-link').click(function(e) {
    e.preventDefault();
    const page = $(this).data('page');
    loadPage(page);
  });

  // Arama
  $('#searchInput').on('keyup', function() {
    const searchTerm = $(this).val();
    const currentPage = $('.nav-link.active').data('page');
    loadPage(currentPage, searchTerm);
  });
});

function loadPage(page, search = '') {
  console.log('Sayfa yükleniyor:', page);
  $('#content').html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i></div>');

  google.script.run
    .withSuccessHandler(function(result) {
      console.log('Sayfa içeriği ve veriler alındı');
      if (result && result.html) {
        // Önce HTML içeriğini yükle
        $('#content').html(result.html);
        $('.nav-link').removeClass('active');
        $(`[data-page="${page}"]`).addClass('active');

        // Sonra verileri tabloya yükle
        if (result.data) {
          switch(page) {
            case 'carihesap':
              $('#cariHesapList').empty();
              result.data.forEach(function(item) {
                $('#cariHesapList').append(`
                  <tr>
                    <td>${item.firmaAdi}</td>
                    <td>${item.subeBolge || '-'}</td>
                    <td>${item.firmaTuru}</td>
                    <td>${item.yetkiliKisi || '-'}</td>
                    <td>${item.telefon || '-'}</td>
                    <td>${item.email || '-'}</td>
                    <td>${item.gorevSayisi || 0}</td>
                    <td>${item.projeSayisi || 0}</td>
                    <td>
                      <button class="btn btn-sm btn-icon btn-warning" onclick="editCariHesap('${item.id}')">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-icon btn-danger" onclick="deleteCariHesap('${item.id}')">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                `);
              });
              break;
            // Diğer sayfalar için benzer işlemler yapılacak
          }
        }
      } else {
        console.error('Sayfa içeriği boş');
        $('#content').html('<div class="alert alert-danger">Sayfa içeriği yüklenemedi</div>');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Sayfa yükleme hatası:', error);
      $('#content').html(`<div class="alert alert-danger">Hata: ${error.message}</div>`);
    })
    .handlePageLoad(page, search);
}

// Form işlemleri
function submitForm(form, handler) {
  const formData = new FormData(form);
  const data = {};
  
  formData.forEach((value, key) => {
    if (key.endsWith('[]')) {
      // Array tipindeki form alanları için
      const cleanKey = key.slice(0, -2);
      if (!data[cleanKey]) {
        data[cleanKey] = [];
      }
      data[cleanKey].push(value);
    } else {
      data[key] = value;
    }
  });

  google.script.run
    .withSuccessHandler(function(result) {
      showAlert('success', 'İşlem başarılı');
      form.reset();
      const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
      if (modal) {
        modal.hide();
      }
      loadPage(getCurrentPage());
    })
    .withFailureHandler(function(error) {
      showAlert('danger', error.message || 'Bir hata oluştu');
      console.error('Form gönderme hatası:', error);
    })[handler](data);

  return false;
}

function getCurrentPage() {
  return $('.nav-link.active').data('page') || 'carihesap';
}

// Yazdırma
function printContent(elementId) {
  const content = document.getElementById(elementId);
  const printWindow = window.open('', '', 'height=600,width=800');

  printWindow.document.write('<html><head><title>Yazdır</title>');
  printWindow.document.write('</head><body>');
  printWindow.document.write(content.innerHTML);
  printWindow.document.write('</body></html>');

  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
  printWindow.close();
}

// Bildirimler
function showAlert(type, message) {
  const alert = `
    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;

  $('#alertArea').html(alert);
  setTimeout(() => $('#alertArea').html(''), 3000);
}

// Cari Hesap İşlemleri
function editCariHesap(id) {
  // ... (Cari hesabı düzenleme işlemini buraya ekleyin)
}

function deleteCariHesap(id) {
  if (confirm('Seçilen cari hesabı silmek istediğinizden emin misiniz?')) {
    google.script.run
      .withSuccessHandler(function(result) {
        showAlert('success', 'Cari hesap başarıyla silindi');
        loadPage('carihesap'); // Sayfayı yeniden yükle
      })
      .withFailureHandler(function(error) {
        showAlert('danger', error.message || 'Cari hesabı silerken bir hata oluştu');
        console.error('Cari hesabı silerken hata:', error);
      })
      .CariHesap.delete(id);
  }
}

function showGorevler(cariHesapId) {
  // ... (Cari hesaba ait görevleri gösteren modal veya başka bir işlem ekleyin)
}

function showProjeler(cariHesapId) {
  // ... (Cari hesaba ait projeleri gösteren modal veya başka bir işlem ekleyin)
}

// Yeni Cari Hesap Ekleme
function submitForm(formId) {
  const form = document.getElementById(formId);
  const formData = new FormData(form);
  const data = {};

  formData.forEach((value, key) => {
    if (value) {
      data[key] = value;
    }
  });

  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.success) {
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("cariHesapModal"),
        );
        if (modal) {
          modal.hide();
        }
        form.reset();
        loadCariHesapList();
      } else {
        alert(
          "Kayıt başarısız: " +
            (result.message || "Bilinmeyen hata"),
        );
      }
    })
    .withFailureHandler(function(error) {
      console.error("Form gönderme hatası:", error);
      alert(
        "Hata: " +
          (error.message ||
            "Bir hata oluştu, lütfen tekrar deneyin"),
      );
    })
    .handlePageLoad("carihesap", "add", data);
}

function loadCariHesapList() {
  google.script.run
    .withSuccessHandler(function(data) {
      const tbody = $("#cariHesapList");
      tbody.empty();
      data.forEach(function(item) {
        tbody.append(`
          <tr>
            <td>${item.firmaAdi}</td>
            <td>${item.subeBolge}</td>
            <td>${item.firmaTuru}</td>
            <td>${item.yetkiliKisi}</td>
            <td>${item.telefon}</td>
            <td>${item.email}</td>
            <td>
              <a href="#" onclick="showGorevler('${item.id}')">${item.gorevSayisi}</a>
            </td>
            <td>
              <a href="#" onclick="showProjeler('${item.id}')">${item.projeSayisi}</a>
            </td>
            <td>
              <button class="btn btn-sm btn-icon btn-warning" onclick="editCariHesap('${item.id}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-icon btn-danger" onclick="deleteCariHesap('${item.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `);
      });
    })
    .withFailureHandler(function(error) {
      console.error("Cari hesap listesi yüklenirken hata oluştu:", error);
      alert("Cari hesap listesi yüklenirken bir hata oluştu. Lütfen tekrar deneyin.");
    })
    .CariHesap.getList();
}
</script>
