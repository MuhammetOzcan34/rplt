<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Teklifler</h3>
    <input type="text" id="searchInput" class="form-control w-25" placeholder="Arama..." oninput="searchTeklifler()">
  </div>

  <!-- Tab Menü -->
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="teklifListesi-tab" data-bs-toggle="tab" data-bs-target="#teklifListesi" type="button" role="tab" aria-controls="teklifListesi" aria-selected="true">
        Teklif Listesi
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="yeniTeklif-tab" data-bs-toggle="tab" data-bs-target="#yeniTeklif" type="button" role="tab" aria-controls="yeniTeklif" aria-selected="false">
        Yeni Teklif Ekle
      </button>
    </li>
  </ul>

  <!-- Tab İçerikleri -->
  <div class="tab-content" id="myTabContent">
    <!-- Teklif Listesi -->
    <div class="tab-pane fade show active" id="teklifListesi" role="tabpanel" aria-labelledby="teklifListesi-tab">
      <div class="table-responsive mt-3">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Teklif No</th>
              <th>Tarih</th>
              <th>Firma Adı</th>
              <th>Teklif Konusu</th>
              <th>Durum</th>
              <th>Toplam Tutar</th>
              <th>İşlemler</th>
            </tr>
          </thead>
          <tbody id="teklifList"></tbody>
        </table>
      </div>

      <!-- Sayfalama -->
      <nav>
        <ul class="pagination justify-content-center">
          <li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>
          <li class="page-item"><a class="page-link" href="#" onclick="changePage(2)">2</a></li>
          <li class="page-item"><a class="page-link" href="#" onclick="showAllTeklifler()">Tümü</a></li>
        </ul>
      </nav>
    </div>

    <!-- Yeni Teklif Ekle -->
    <div class="tab-pane fade" id="yeniTeklif" role="tabpanel" aria-labelledby="yeniTeklif-tab">
      <form id="teklifForm" class="mt-3" onsubmit="submitTeklifForm(event)">
        <!-- Form alanları buraya eklenecek -->
      </form>
    </div>
  </div>
</div>

<!-- JavaScript Fonksiyonları -->
<script>
  let currentPage = 1;

  // Teklif listesini yükle
  function loadTeklifList(data) {
    const tbody = $('#teklifList');
    tbody.empty();
    
    data.forEach(function(item) {
      tbody.append(`
        <tr data-id="${item.id}">
          <td>${item.teklifNo}</td>
          <td>${item.tarih}</td>
          <td>${item.firmaAdi}</td>
          <td>${item.teklifKonusu}</td>
          <td>${item.teklifDurumu}</td>
          <td>${item.toplamTutar}</td>
          <td>
            <button class="btn btn-sm btn-icon btn-warning" onclick="editTeklif('${item.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-icon btn-danger" onclick="deleteTeklif('${item.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `);
    });
  }

  // Dinamik Arama
  function searchTeklifler() {
    const searchTerm = $('#searchInput').val();
    loadPage('teklif', searchTerm, currentPage);
  }

  // Sayfa değiştirme
  function changePage(page) {
    currentPage = page;
    loadPage('teklif', $('#searchInput').val(), currentPage);
  }

  // Tümünü göster
  function showAllTeklifler() {
    currentPage = 1;
    loadPage('teklif', $('#searchInput').val(), 0); // 0, tümünü göster anlamına gelir
  }

  // Teklif Silme
  function deleteTeklif(id) {
    if (!confirm("Bu teklifi silmek istediğinize emin misiniz?")) return;
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          alert("Teklif başarıyla silindi.");
          loadPage('teklif');
        } else {
          alert("Silme işlemi başarısız!");
        }
      })
      .deleteTeklif(id);
  }

  // Teklif Düzenleme
  function editTeklif(id) {
    const row = document.querySelector(`tr[data-id='${id}']`);
    if (!row) {
      alert("Kayıt bulunamadı!");
      return;
    }
    const updatedData = {
      id: id,
      teklifNo: row.querySelector(".teklifNo") ? row.querySelector(".teklifNo").innerText : "",
      teklifTuru: row.querySelector(".teklifTuru") ? row.querySelector(".teklifTuru").innerText : "",
      tarih: row.querySelector(".tarih") ? row.querySelector(".tarih").innerText : "",
      firmaAdi: row.querySelector(".firmaAdi") ? row.querySelector(".firmaAdi").innerText : "",
      teklifKonusu: row.querySelector(".teklifKonusu") ? row.querySelector(".teklifKonusu").innerText : "",
      yetkiliKisi: row.querySelector(".yetkiliKisi") ? row.querySelector(".yetkiliKisi").innerText : "",
      teklifDurumu: row.querySelector(".teklifDurumu") ? row.querySelector(".teklifDurumu").innerText : "",
      odemeKosulu: row.querySelector(".odemeKosulu") ? row.querySelector(".odemeKosulu").innerText : "",
      gecerlilikSuresi: row.querySelector(".gecerlilikSuresi") ? row.querySelector(".gecerlilikSuresi").innerText : "",
      toplamTutar: row.querySelector(".toplamTutar") ? row.querySelector(".toplamTutar").innerText : ""
    };
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          alert("Teklif başarıyla güncellendi.");
          loadPage('teklif');
        } else {
          alert("Güncelleme başarısız!");
        }
      })
      .updateTeklif(updatedData);
  }
</script>
