<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Teklifler</h3>
    <input type="text" id="searchInput" class="form-control w-25" placeholder="Arama..." oninput="searchTeklifler()">
  </div>

  <!-- Tab Menü -->
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="teklifListesi-tab" data-bs-toggle="tab" data-bs-target="#teklifListesi" type="button" role="tab" aria-controls="teklifListesi" aria-selected="true">
        Teklif Listesi
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="yeniTeklif-tab" data-bs-toggle="tab" data-bs-target="#yeniTeklif" type="button" role="tab" aria-controls="yeniTeklif" aria-selected="false">
        Yeni Teklif Ekle
      </button>
    </li>
  </ul>

  <!-- Tab İçerikleri -->
  <div class="tab-content" id="myTabContent">
    <!-- Teklif Listesi -->
    <div class="tab-pane fade show active" id="teklifListesi" role="tabpanel" aria-labelledby="teklifListesi-tab">
      <div class="table-responsive mt-3">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Teklif No</th>
              <th>Tarih</th>
              <th>Firma Adı</th>
              <th>Teklif Konusu</th>
              <th>Durum</th>
              <th>Toplam Tutar</th>
              <th>İşlemler</th>
            </tr>
          </thead>
          <tbody id="teklifList"></tbody>
        </table>
      </div>

      <!-- Sayfalama -->
      <nav>
        <ul class="pagination justify-content-center">
          <li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>
          <li class="page-item"><a class="page-link" href="#" onclick="changePage(2)">2</a></li>
          <li class="page-item"><a class="page-link" href="#" onclick="showAllTeklifler()">Tümü</a></li>
        </ul>
      </nav>
    </div>

    <!-- Yeni Teklif Ekle -->
    <div class="tab-pane fade" id="yeniTeklif" role="tabpanel" aria-labelledby="yeniTeklif-tab">
      <form id="teklifForm" class="mt-3" onsubmit="submitTeklifForm(event)">
        <!-- Genel Bilgiler -->
        <h5>Genel Bilgiler</h5>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="teklifTuru">Teklif Türü</label>
              <select id="teklifTuru" class="form-control" required>
                <option value="Verilen">Verilen Teklif</option>
                <option value="Alınan">Alınan Teklif</option>
              </select>
            </div>
            <div class="form-group">
              <label for="firmaAdi">Firma Adı</label>
              <select id="firmaAdi" class="form-control" required></select>
            </div>
            <div class="form-group">
              <label for="teklifKonusu">Teklif Konusu</label>
              <input type="text" id="teklifKonusu" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="yetkiliKisi">Yetkili Kişi</label>
              <select id="yetkiliKisi" class="form-control" required></select>
            </div>
            <div class="form-group">
              <label for="teklifDurumu">Teklif Durumu</label>
              <select id="teklifDurumu" class="form-control" required>
                <option value="Beklemede">Beklemede</option>
                <option value="Onaylandı">Onaylandı</option>
                <option value="Kaybedildi">Kaybedildi</option>
                <option value="İptal">İptal</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="tarih">Tarih</label>
              <input type="date" id="tarih" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="odemeSekli">Ödeme Şekli</label>
              <input type="text" id="odemeSekli" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="gecerlilikSuresi">Geçerlilik Süresi</label>
              <input type="text" id="gecerlilikSuresi" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="alinanTeklifler">Alınan Teklifler</label>
              <select id="alinanTeklifler" class="form-control" multiple></select>
            </div>
            <div class="form-group">
              <label for="dosyalar">Dosyalar</label>
              <input type="file" id="dosyalar" class="form-control" multiple>
            </div>
          </div>
        </div>

        <!-- Ürün/Hizmet Bilgileri -->
        <h5>Ürün/Hizmet Bilgileri</h5>
        <div class="form-group d-flex justify-content-end">
          <label class="mr-3">
            <input type="checkbox" id="iskontoCheckbox">
            <span>İskonto Ekle</span>
          </label>
          <label>
            <input type="checkbox" id="kdvCheckbox">
            <span>KDV Ekle</span>
          </label>
        </div>
        <table class="table product-table">
          <thead>
            <tr>
              <th>Ürün / Hizmet Adı</th>
              <th>Özellikleri</th>
              <th>Miktar</th>
              <th>Birim</th>
              <th>Birim Fiyat</th>
              <th>PB</th>
              <th>Tutar</th>
              <th class="iskonto-container hidden">İskonto Tutarı</th>
              <th class="kdvOrani-container hidden">KDV Oranı</th>
              <th>NET TUTAR</th>
            </tr>
          </thead>
          <tbody id="productTableBody">
            <tr>
              <td><input type="text" class="urunAdi"></td>
              <td><input type="text" class="ozellikler"></td>
              <td><input type="number" class="miktar"></td>
              <td>
                <select class="birim">
                  <option value="Adet" selected>Adet</option>
                  <option value="Cilt">Cilt</option>
                  <option value="Koçan">Koçan</option>
                  <option value="Paket">Paket</option>
                  <option value="Koli">Koli</option>
                  <option value="Ton">Ton</option>
                  <option value="Kg">Kg</option>
                  <option value="g">g</option>
                  <option value="Lt">Lt</option>
                  <option value="ml">ml</option>
                  <option value="Metre">Metre</option>
                </select>
              </td>
              <td><input type="text" class="birimFiyat" placeholder="0,00"></td>
              <td>
                <select class="paraBirimi">
                  <option value="₺" selected>₺</option>
                  <option value="$">$</option>
                  <option value="€">€</option>
                </select>
              </td>
              <td><input type="text" class="tutar" readonly></td>
              <td class="iskonto-container hidden"><input type="text" class="iskontoTutar"></td>
              <td class="kdvOrani-container hidden"><input type="text" class="kdvOrani" placeholder="%"></td>
              <td class="netTutar-container"><input type="text" class="netTutar" readonly></td>
            </tr>
          </tbody>
        </table>
        <div class="add-row-btn">
          <button class="btn" type="button" onclick="addRow()">EKLE</button>
        </div>
        <div class="save-btn">
          <button class="btn btn-primary" type="submit">KAYDET</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript Fonksiyonları -->
<script>
  let currentPage = 1;

  // Teklif listesini yükle
  function loadTeklifList(data) {
    const tbody = $('#teklifList');
    tbody.empty();
    
    data.forEach(function(item) {
      tbody.append(`
        <tr data-id="${item.id}">
          <td>${item.teklifNo}</td>
          <td>${item.tarih}</td>
          <td>${item.firmaAdi}</td>
          <td>${item.teklifKonusu}</td>
          <td>${item.teklifDurumu}</td>
          <td>${item.toplamTutar}</td>
          <td>
            <button class="btn btn-sm btn-icon btn-warning" onclick="editTeklif('${item.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-icon btn-danger" onclick="deleteTeklif('${item.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `);
    });
  }

  // Dinamik Arama
  function searchTeklifler() {
    const searchTerm = $('#searchInput').val();
    loadPage('teklif', searchTerm, currentPage);
  }

  // Sayfa değiştirme
  function changePage(page) {
    currentPage = page;
    loadPage('teklif', $('#searchInput').val(), currentPage);
  }

  // Tümünü göster
  function showAllTeklifler() {
    currentPage = 1;
    loadPage('teklif', $('#searchInput').val(), 0); // 0, tümünü göster anlamına gelir
  }

  // Teklif Silme
  function deleteTeklif(id) {
    if (!confirm("Bu teklifi silmek istediğinize emin misiniz?")) return;
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          alert("Teklif başarıyla silindi.");
          loadPage('teklif');
        } else {
          alert("Silme işlemi başarısız!");
        }
      })
      .deleteTeklif(id);
  }

  // Teklif Düzenleme
  function editTeklif(id) {
    const row = document.querySelector(`tr[data-id='${id}']`);
    if (!row) {
      alert("Kayıt bulunamadı!");
      return;
    }
    const updatedData = {
      id: id,
      teklifNo: row.querySelector(".teklifNo") ? row.querySelector(".teklifNo").innerText : "",
      teklifTuru: row.querySelector(".teklifTuru") ? row.querySelector(".teklifTuru").innerText : "",
      tarih: row.querySelector(".tarih") ? row.querySelector(".tarih").innerText : "",
      firmaAdi: row.querySelector(".firmaAdi") ? row.querySelector(".firmaAdi").innerText : "",
      teklifKonusu: row.querySelector(".teklifKonusu") ? row.querySelector(".teklifKonusu").innerText : "",
      yetkiliKisi: row.querySelector(".yetkiliKisi") ? row.querySelector(".yetkiliKisi").innerText : "",
      teklifDurumu: row.querySelector(".teklifDurumu") ? row.querySelector(".teklifDurumu").innerText : "",
      odemeKosulu: row.querySelector(".odemeKosulu") ? row.querySelector(".odemeKosulu").innerText : "",
      gecerlilikSuresi: row.querySelector(".gecerlilikSuresi") ? row.querySelector(".gecerlilikSuresi").innerText : "",
      toplamTutar: row.querySelector(".toplamTutar") ? row.querySelector(".toplamTutar").innerText : ""
    };
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          alert("Teklif başarıyla güncellendi.");
          loadPage('teklif');
        } else {
          alert("Güncelleme başarısız!");
        }
      })
      .updateTeklif(updatedData);
  }

  function addRow() {
    const row = `
      <tr>
        <td><input type="text" class="urunAdi"></td>
        <td><input type="text" class="ozellikler"></td>
        <td><input type="number" class="miktar"></td>
        <td>
          <select class="birim">
            <option value="Adet" selected>Adet</option>
            <option value="Cilt">Cilt</option>
            <option value="Koçan">Koçan</option>
            <option value="Paket">Paket</option>
            <option value="Koli">Koli</option>
            <option value="Ton">Ton</option>
            <option value="Kg">Kg</option>
            <option value="g">g</option>
            <option value="Lt">Lt</option>
            <option value="ml">ml</option>
            <option value="Metre">Metre</option>
          </select>
        </td>
        <td><input type="text" class="birimFiyat" placeholder="0,00"></td>
        <td>
          <select class="paraBirimi">
            <option value="₺" selected>₺</option>
            <option value="$">$</option>
            <option value="€">€</option>
          </select>
        </td>
        <td><input type="text" class="tutar" readonly></td>
        <td class="iskonto-container hidden"><input type="text" class="iskontoTutar"></td>
        <td class="kdvOrani-container hidden"><input type="text" class="kdvOrani" placeholder="%"></td>
        <td class="netTutar-container"><input type="text" class="netTutar" readonly></td>
      </tr>
    `;
    $('#productTableBody').append(row);
    $('select').formSelect();
  }

  $(document).on('input change', '.miktar, .birimFiyat, .iskontoTutar, .kdvOrani', function() {
    const row = $(this).closest('tr');
    const miktar = parseFloat(row.find('.miktar').val()) || 0;
    const birimFiyat = parseFloat(row.find('.birimFiyat').val().replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
    const iskontoTutar = parseFloat(row.find('.iskontoTutar').val().replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
    const kdvOrani = parseFloat(row.find('.kdvOrani').val().replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
    const paraBirimi = row.find('.paraBirimi').val() || '₺';

    const tutar = miktar * birimFiyat;
    const netTutar = tutar - iskontoTutar;
    const kdvliTutar = netTutar + (netTutar * (kdvOrani / 100));

    row.find('.tutar').val(`${tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${paraBirimi}`);
    row.find('.netTutar').val(`${kdvliTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${paraBirimi}`);
  });

  $('#iskontoCheckbox').change(function() {
    if ($(this).is(':checked')) {
      $('.iskonto-container').removeClass('hidden');
    } else {
      $('.iskonto-container').addClass('hidden');
    }
  });

  $('#kdvCheckbox').change(function() {
    if ($(this).is(':checked')) {
      $('.kdvOrani-container').removeClass('hidden');
    } else {
      $('.kdvOrani-container').addClass('hidden');
    }
  });
</script>
